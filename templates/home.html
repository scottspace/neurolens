<!doctype html>
<!--
 Copyright 2021 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroLens File Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='dist/css/output.css')}}">
    <!-- FilePond CSS -->
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <!-- FilePond Plugins -->
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
    <script
        src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.js"></script>
    <link href="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.css" rel="stylesheet">
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet" />
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.js"></script>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
</head>

<body class="bg-gradient-to-b text-white from-gray-900 to-gray-800 min-h-screen flex flex-col items-center">

    <!-- Header -->

    <nav id="topbar" class="bg-white shadow-md dark:bg-gray-900">
        <div class="max-w-screen-xl mx-auto p-4 flex justify-between items-center">
            <!-- Hamburger Menu (Left Side) -->
            <button id="hamburger-menu" data-collapse-toggle="mobile-menu" type="button"
                class="inline-flex items-center p-2 w-10 h-10 justify-center text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                aria-controls="mobile-menu" aria-expanded="false">
                <span class="sr-only">Open main menu</span>
                <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>

            <!-- Right-Aligned Eyeball Logo -->
            <a href="#" class="flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-10 h-10 text-gray-800 dark:text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.253.74-.558 1.449-.908 2.122M2.458 12a16.098 16.098 0 00.908 2.122m-.908-2.122A16.094 16.094 0 012.458 12m0 0c1.274 4.057 5.065 7 9.542 7 4.478 0 8.268-2.943 9.542-7" />
                </svg>
            </a>

            <!-- Hidden Links for Desktop -->
            <div class="hidden w-full md:block md:w-auto" id="desktop-menu">
                <ul class="flex flex-col md:flex-row md:space-x-8 text-gray-700 dark:text-white font-medium">
                    <li>
                        <a href="#"
                            class="block py-2 px-3 rounded md:p-0 hover:text-blue-600 dark:hover:text-blue-400">Home</a>
                    </li>
                    <li>
                        <a href="#"
                            class="reset-menu block py-2 px-3 rounded md:p-0 hover:text-blue-600 dark:hover:text-blue-400">Reset</a>
                    </li>
                    <li>
                        <a href="#"
                            class="logout-menu block py-2 px-3 rounded md:p-0 hover:text-blue-600 dark:hover:text-blue-400">Logout</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Sliding Mobile Menu -->
        <div id="mobile-menu"
            class="fixed top-0 left-0 w-3/4 h-full bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden dark:bg-gray-900">
            <div class="p-4">
                <button id="close-menu" class="text-gray-600 dark:text-gray-400">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <ul class="mt-6 space-y-6">
                    <li><a href="#"
                            class="block text-gray-800 dark:text-white text-lg font-medium hover:text-blue-600 dark:hover:text-blue-400">Home</a>
                    </li>
                    <li><a href="#"
                            class="reset-menu block text-gray-800 dark:text-white text-lg font-medium hover:text-blue-600 dark:hover:text-blue-400">Reset!</a>
                    </li>
                    <li><a href="#"
                            class="logout-menu block text-gray-800 dark:text-white text-lg font-medium hover:text-blue-600 dark:hover:text-blue-400">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <p></p>

    <!-- Training banner --->

    <div id="informational-banner" data-dismiss-mode="hide" tabindex="-1"
        class="hidden fixed top-2 left-0 right-0 z-50 flex flex-col md:flex-row justify-between w-full max-w-screen-lg mx-auto p-4 border-b border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600">

        <!-- Text Section -->
        <div class="mb-4 md:mb-0 md:mr-4">
            <h2 class="mb-1 text-base font-semibold text-gray-900 dark:text-white">Congrats!</h2>
            <p class="flex items-center text-sm font-normal text-gray-500 dark:text-gray-400">
                You have enough images to train your personal AI influencer.
            </p>
        </div>

        <!-- Buttons Section -->
        <div class="flex items-center justify-between space-x-4">
            <a id="train-button" href="#"
                class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                Train My AI
                <svg class="w-3 h-3 ml-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 14 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M1 5h12m0 0L9 1m4 4L9 9" />
                </svg>
            </a>

            <!-- Close Button -->
            <button data-dismiss-target="#informational-banner" type="button"
                class="flex-shrink-0 inline-flex justify-center w-7 h-7 items-center text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg p-1.5 dark:hover:bg-gray-600 dark:hover:text-white">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                </svg>
                <span class="sr-only">Close banner</span>
            </button>
        </div>
    </div>

    <!-- Training Underway Banner -->
    <div id="training-banner"
        class="hidden flex flex-col md:flex-row items-center p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400 max-w-screen-lg mx-auto"
        role="alert">

        <!-- Icon Section -->
        <svg class="flex-shrink-0 w-5 h-5 mb-2 md:mb-0 md:mr-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>

        <!-- Text Section -->
        <div>
            <span class="font-medium">Note:</span> Your AI is training. This will take about 30 minutes.
        </div>
    </div>

    <!-- Training Fail Banner -->
    <div id="training-error"
        class="hidden flex flex-col md:flex-row items-center mt-2 p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 max-w-screen-lg mx-auto"
        role="alert">

        <!-- Icon Section -->
        <svg class="flex-shrink-0 w-5 h-5 mb-2 md:mb-0 md:mr-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>

        <!-- Text Section -->
        <div>
            <span class="font-medium">Whoops!</span> There was an error training your AI. Please try again.
        </div>
    </div>


    <!-- Generation Underway Banner -->
    <div id="generation-banner"
        class="hidden flex flex-col md:flex-row items-center mt-2 p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400 max-w-screen-lg mx-auto"
        role="alert">

        <!-- Icon Section -->
        <svg class="flex-shrink-0 w-5 h-5 mb-2 md:mb-0 md:mr-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>

        <!-- Text Section -->
        <div>
            <span class="font-medium">Note:</span> Your Image is generating. This can take about 1-2 minutes.
        </div>
    </div>


    <!-- Generation Fail Banner -->
    <div id="generation-error"
        class="hidden flex flex-col md:flex-row items-center mt-2 p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 max-w-screen-lg mx-auto"
        role="alert">

        <!-- Icon Section -->
        <svg class="flex-shrink-0 w-5 h-5 mb-2 md:mb-0 md:mr-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>

        <!-- Text Section -->
        <div>
            <span class="font-medium">Whoops!</span> There was an error generating your image. Please try again.
        </div>
    </div>


    <!-- Title -->
    <header class="py-10">
        <h1 class="text-5xl font-bold text-amber-500">Neuro Lens</h1>
    </header>

    <!-- Instructional Paragraph -->
    <p class="text-center text-lg mb-8" id="instruction">Please upload images to feed your personal AI Influencer</p>

    <!-- FilePond File Uploader -->
    <div class="pond" id="pond_div">
        <input type="file" multiple class="filepond" name="filepond" id="filepond" data-max-files="25"
            data-max-file-size="3MB">
    </div>

    <!-- image generation prompt -->
    <div class="hidden" id="generation-form">
        <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
            <!-- X Button to Clear the Input -->
            <button id="clear-prompt-btn"
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.707a1 1 0 00-1.414-1.414L10 8.586 7.707 6.293a1 1 0 00-1.414 1.414L8.586 10l-2.293 2.293a1 1 0 001.414 1.414L10 11.414l2.293 2.293a1 1 0 001.414-1.414L11.414 10l2.293-2.293z"
                        clip-rule="evenodd" />
                </svg>
            </button>

            <div class="px-4 py-2 bg-white rounded-t-lg dark:bg-gray-800">
                <label for="prompt" class="sr-only">Your prompt</label>
                <textarea id="prompt" rows="4"
                    class="w-full px-0 text-sm text-gray-900 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400"
                    placeholder="Describe an image using me:-) as your AI's name..." required></textarea>
            </div>

            <!-- Button Section with separation and distinct styles -->
            <div class="flex items-center justify-between px-3 py-2 border-t dark:border-gray-600">
                <!-- Random Prompt Button (left, informative) -->
                <button id="random-prompt-btn"
                    class="py-2.5 px-4 text-xs font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-700 dark:text-white dark:bg-gray-600 dark:hover:bg-gray-500">
                    Random Prompt
                </button>

                <!-- Generate Button (right, CTA) -->
                <button id="generate-button"
                    class="py-2.5 px-6 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800">
                    Generate
                </button>
            </div>
        </div>
    </div>

    <!-- Gallery -->
    <div id="gallery"></div>

    <!-- Hidden modal for larger image -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden p-4">
        <span id="closeModal" class="absolute top-4 right-4 text-white cursor-pointer text-3xl">&times;</span>
        <img id="modalImage"
            class="rounded-lg transform scale-90 transition duration-500 ease-in-out max-w-full max-h-full md:max-w-3/4 md:max-h-3/4">
    </div>

    <!-- Modal reset (initially hidden) -->
    <div id="reset-modal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
            <h2 class="text-lg font-semibold mb-4">Confirm Reset</h2>
            <p class="text-gray-700 mb-6">This will delete your model and all images. Are you sure you want to proceed?
            </p>
            <div class="flex justify-end">
                <button id="cancel-reset"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">Cancel</button>
                <button id="confirm-reset"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <!-- FilePond JS -->
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>

    <!-- Initialize FilePond -->
    <script>

        FilePond.registerPlugin(
            // validates the size of the file
            FilePondPluginFileValidateSize,
            // corrects mobile image orientation
            FilePondPluginImageExifOrientation,
            FilePondPluginFilePoster
        );

        // override default options
        FilePond.setOptions({
            dropOnPage: true,
            dropOnElement: true,
            maxFileSize: "20MB"
        });

    </script>

    <!-- local script -->
    <script>
        $(document).ready(function () {

            // get a reference to the input element
            const inputElement = document.querySelector('input[type="file"]')

            const pond = FilePond.create(inputElement, {
                allowMultiple: true,
                maxFiles: 25,
                credits: false,
                server: {
                    url: 'https://neurolens.scott.ai',
                    process: '/upload',
                    revert: null,
                    headers: {
                        // Add any necessary headers here
                        'session': get_session_id()
                    }
                }
            })

            function hide_it(id) {
                $(id).removeClass('block').addClass('hidden');
            }

            function show_it(id) {
                $(id).removeClass('hidden').addClass('block');
            }

            // Open the sliding mobile menu
            $('[data-collapse-toggle]').on('click', function () {
                $('#mobile-menu').removeClass('-translate-x-full');
                $('#desktop-menu').addClass('hidden');  // Ensure the desktop menu is hidden
            });

            // Close the sliding mobile menu
            $('#close-menu').on('click', function () {
                $('#mobile-menu').addClass('-translate-x-full');
                $('#desktop-menu').removeClass('hidden');  // Show the desktop menu if screen size allows
            });

            function use_submit_state() {
                console.log("showing informational banner");
                show_it('#informational-banner');
                hide_it('#generation-form');
                hide_it('#training-banner');
            }

            function use_training_state() {
                console.log("showing training banner");
                hide_it('#informational-banner');
                hide_it('#generation-form');
                show_it('#training-banner');
            }

            function use_generation_state() {
                console.log("showing generation form");
                $('#instruction').text("Describe a vision for me:-)");
                hide_it('#informational-banner');
                hide_it('#training-banner');
                show_it('#generation-form');
                hide_it('#pond_div');
                pond.destroy();
            }

            function use_unknown_state() {
                console.log("hiding both banners");
                hide_it('#informational-banner');
                hide_it('#training-banner');
                hide_it('#generation-form');
            }

            function train_bar() {
                $.ajax({
                    url: '/state',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        //info['state'] = 'ready' // TODO remove
                        if (info['state'] == 'submit') {
                            use_submit_state();
                        } else if (info['state'] == 'training') {
                            use_training_state();
                        } else if (info['state'] == 'ready') {
                            use_generation_state();
                        }
                        else {
                            use_unknown_state();
                        }
                        console.log(info);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error getting state.');
                        hide_it('#informational-banner');
                    }
                });

            }

            function invalidate() {
                $.ajax({
                    url: '/clear',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        console.log(info);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error clearing gallery.');
                    }
                });

            }

            function loadGallery() {
                $.ajax({
                    url: '/grid',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (data) {
                        // On success, replace the content of the #gallery div with the response data
                        $('#gallery').html(data);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        $('#gallery').html('<p>Error loading gallery.</p>');
                    }
                });
            }

            function startTrain() {
                $.ajax({
                    url: '/train',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (data) {
                        // On success, replace the content of the #gallery div with the response data
                        train_bar();
                        hide_it('#informational-banner');
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log("Error during training.");
                        hide_it('#informational-banner');
                        hide_it('#training-banner');
                        show_it('#training-error');

                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#training-error');

                            // Call the train-bar function after the message disappears
                            train_bar();
                        }, 5000);
                    }
                });
            }

            // Event listener when a file has been processed (uploaded)
            pond.on('processfile', function (error, file) {
                if (!error) {
                    pond.removeFile(file.id); // remove the file from the pond
                    invalidate(); // clear the zip file
                    loadGallery(); // show all
                    train_bar(); // check if we have enough images
                }
            });

            // train button
            $('#train-button').on('click', function () {
                startTrain();
            });

            // 
            function add_gallery_skeleton_image() {
                var div = '<div class="relative flex justify-center items-center">';
                div += '<div class="skeleton bg-gray-200 animate-pulse h-48 w-full rounded-lg"></div>';
                div += '</div>'
                $('#gallery-images').prepend(div);
            }

            //
            // Image generation
            //

            // Clear the input (textarea) when the "X" button is clicked
            $('#clear-prompt-btn').on('click', function () {
                $('#prompt').val(''); // Clear the textarea
            });

            function generate_image() {
                $.ajax({
                    url: '/genImage',        // The URL for the AJAX request
                    type: 'POST',            // Method of the request
                    contentType: 'application/json',
                    headers: { 'session': get_session_id() },
                    data: JSON.stringify({
                        prompt: $('#prompt').val()
                    }),
                    success: function (data) {
                        // Turn off the generate button while we wait
                        // and monitor the outcome.
                        $('#generate-button').prop('disabled', true)
                        add_gallery_skeleton_image();
                        monitor_generation();
                        console.log("Success: ");
                        console.log(data);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log("Error generating image.");
                        show_it('#generation-error');
                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#generation-error');
                            $('#generate-button').prop('disabled', false)
                        }, 5000);
                    }
                });
            }

            function monitor_generation() {
                $.ajax({
                    url: '/image_status',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        if (info['status'] == 'succeeded') {
                            // Turn on the generate button
                            $('#generate-button').prop('disabled', false)
                            hide_it('#generation-banner');
                            loadGallery();
                            train_bar();
                        } else if (info['status'] == 'error') {
                            show_it('#generation-error');
                            // Hide the error message after 5 seconds (5000 milliseconds)
                            setTimeout(function () {
                                hide_it('#generation-error');
                                $('#generate-button').prop('disabled', false)
                            }, 5000);
                        } else {
                            // Keep checking
                            show_it('#generation-banner');
                            setTimeout(monitor_generation, 5000);
                        }
                        console.log(info); // TODO remove
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error getting state.');
                        hide_it('#generation-banner');
                        show_it('#generation-error');
                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#generation-error');
                            $('#generate-button').prop('disabled', false)
                        }, 5000);
                    }
                });
            }

            // generate button
            $('#generate-button').on('click', function () {
                console.log("We will generate the image now.");
                generate_image();
            });

            // logout button
            $('.logout-menu').on('click', function () {

                // hide mobile menu
                $('#mobile-menu').addClass('-translate-x-full');
                $('#desktop-menu').addClass('hidden');

                $.ajax({
                    url: '/logout',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    headers: { 'session': get_session_id() },
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        console.log(info);
                        clear_session(); // important
                        window.location.href = info['url'];
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error logging out.');
                    }
                });
            });

            // Event listener for the reset menu item
            $('.reset-menu').on('click', function () {
                // hide mobile menu
                $('#mobile-menu').addClass('-translate-x-full');
                $('#desktop-menu').addClass('hidden');
                // Show the modal
                $('#reset-modal').removeClass('hidden');
            });

            // Event listener for the Cancel button
            $('#cancel-reset').on('click', function () {
                // Hide the modal without taking any action
                $('#reset-modal').addClass('hidden');
            });

            // Event listener for the Confirm button
            $('#confirm-reset').on('click', function () {
                // Perform the reset action (e.g., delete model and images)
                $.ajax({
                    url: '/reset',
                    type: 'GET',
                    headers: { 'session': get_session_id() },

                    success: function (info) {
                        // Successfully reset the data, you can refresh or update UI accordingly
                        console.log('Reset successful');
                        $('#reset-modal').addClass('hidden');
                        loadGallery();
                    },

                    error: function (xhr, status, error) {
                        // Handle errors during the reset process
                        console.log('Error performing reset.');
                    }
                });
            });

            // image kill switch for dynamic content, bind to doc instead
            $(document).on('click', '.kill', function () {
                var url = $(this).attr('data-url');
                var image_id = '#' + $(this).attr('data-image-id');
                console.log("Clicked on " + url);

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: { 'session': get_session_id() },
                    success: function (info) {
                        // On success, fade out the image and then remove it from the DOM
                        console.log(info);
                        $(image_id).fadeOut(500, function () {
                            $(this).remove();
                        });
                    },

                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error deleting image.');
                    }
                });
            });

            // viewing an image
            $(document).on('click', '.gallery-image', function () {
                // Get the large image URL from the data attribute
                const largeImageUrl = $(this).data('large');

                // Set the modal image src to the large image URL
                $('#modalImage').attr('src', largeImageUrl);

                // Show the modal with a smooth scale transition
                $('#imageModal').removeClass('hidden');
                setTimeout(function () {
                    $('#modalImage').removeClass('scale-90').addClass('scale-100');
                }, 100); // Delay to allow smooth transition
            });

            // Close the modal on close button click
            $('#closeModal').on('click', function () {
                // Add the scale-90 class back for the shrink effect
                $('#modalImage').removeClass('scale-100').addClass('scale-90');

                // Hide the modal after the transition
                setTimeout(function () {
                    $('#imageModal').addClass('hidden');
                }, 500); // Match the duration of the transition
            });

            // Close modal when clicking outside the image
            $('#imageModal').on('click', function (e) {
                if ($(e.target).is('#imageModal') || $(e.target).is('#closeModal')) {
                    $('#modalImage').removeClass('scale-100').addClass('scale-90');
                    setTimeout(function () {
                        $('#imageModal').addClass('hidden');
                    }, 500);
                }
            });

            // load our gallery
            loadGallery();

            // check if we have enough images
            train_bar();

            // prompts
            // Array of predefined prompts
            const prompts = [
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is strolling along the cobblestone streets of a quaint European village in early summer, wearing a tailored linen shirt and dark jeans, golden sunlight casting long shadows, with a lively market in the background, locals chatting and street musicians playing.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is lounging on a luxurious yacht deck in the Mediterranean, wearing a white button-up shirt and sunglasses, the sun setting over calm waters, with the coastline of a charming Italian town in the distance and a few friends laughing around.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is sipping coffee at a chic Parisian caf√© on a crisp autumn morning, wearing a stylish wool coat and scarf, the Eiffel Tower in the background, golden leaves scattered on the ground, and people walking by immersed in conversation.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is hiking through a lush green rainforest in South America, wearing an athletic tank top and hiking pants, with misty mountains in the background and exotic birds flying above, sunlight filtering through the dense trees.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is standing on a rooftop in New York City at night, wearing a sleek black blazer and turtleneck, the city skyline illuminated with skyscrapers and bright lights, with a cocktail in hand and a trendy crowd enjoying the evening around him.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is strolling along a tropical beach at sunrise, wearing light swim trunks and a loose shirt, the ocean waves gently rolling onto the shore, with palm trees swaying in the background and a few joggers passing by.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is relaxing by an infinity pool overlooking the ocean at a luxury resort, wearing sunglasses and a casual button-down shirt, the setting sun casting a golden glow on the scene, with a few people swimming in the background and tropical drinks on the side table.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is attending a rooftop garden party in Tokyo at sunset, wearing a sharp navy blue suit, surrounded by modern cityscapes and neon lights, with guests mingling and enjoying sushi and cocktails, the Tokyo Tower in the distance.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is skiing down a snowy mountain in the Swiss Alps on a clear winter morning, wearing a sleek ski jacket and goggles, the sun shining brightly on the pristine white slopes, with other skiers in the background carving down the mountain.",
                "An HD photo, photorealistic, super detailed, 35mm of me:-) who is standing on the deck of a luxury safari lodge in Africa at sunset, wearing a light khaki outfit, with vast savannah stretching out into the distance, a herd of elephants grazing in the background, and the golden light of the setting sun creating a serene atmosphere."
            ];

            // Handle Random Prompt Button click
            $('#random-prompt-btn').on('click', function () {
                // Select a random prompt from the array
                const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];

                // Insert the random prompt into the textarea
                $('#prompt').val(randomPrompt);
            });
        });

    </script>

</body>

</html>
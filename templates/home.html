<!doctype html>
<!--
 Copyright 2021 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroLens File Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='dist/css/output.css')}}">
    <!-- FilePond CSS -->
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <!-- FilePond Plugins -->
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
    <script
        src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.js"></script>
    <link href="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.css" rel="stylesheet">
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet" />
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.js"></script>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
</head>

<body class="bg-gradient-to-b text-white from-gray-900 to-gray-800 min-h-screen flex flex-col items-center">

    <!-- Training banner --->

    <div id="informational-banner" data-dismiss-mode="hide" tabindex="-1"
        class="hidden fixed top-0 start-0 z-50 flex flex-col justify-between w-full p-4 border-b border-gray-200 md:flex-row bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
        <div class="mb-4 md:mb-0 md:me-4">
            <h2 class="mb-1 text-base font-semibold text-gray-900 dark:text-white">Congrats!</h2>
            <p class="flex items-center text-sm font-normal text-gray-500 dark:text-gray-400">You have enough images to
                train your personal AI influencer.</p>
        </div>
        <div class="flex items-center flex-shrink-0">
            <a id="train-button" href="#"
                class="inline-flex items-center justify-center px-3 py-2 me-2 text-xs font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Train
                My AI <svg class="w-3 h-3 ms-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 14 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M1 5h12m0 0L9 1m4 4L9 9" />
                </svg></a>
            <button data-dismiss-target="#informational-banner" type="button"
                class="flex-shrink-0 inline-flex justify-center w-7 h-7 items-center text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 dark:hover:bg-gray-600 dark:hover:text-white">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                </svg>
                <span class="sr-only">Close banner</span>
            </button>
        </div>
    </div>

    <!-- Training Underway -->
    <div id="training-banner"
        class="hidden flex items-center p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400"
        role="alert">
        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>
        <span class="sr-only">Info</span>
        <div>
            <span class="font-medium">Note:</span> Your AI is training. This will take about 30 minutes.
        </div>
    </div>

    <!-- Training Fail -->
    <div id="training-error"
        class="hidden flex items-center p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"
        role="alert">
        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>
        <span class="sr-only">Info</span>
        <div>
            <span class="font-medium">Whoops!</span> There was an error training your AI. Please try again.
        </div>
    </div>

    <!-- Generation Underway -->
    <div id="generation-banner"
        class="hidden flex items-center p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400"
        role="alert">
        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>
        <span class="sr-only">Info</span>
        <div>
            <span class="font-medium">Note:</span> Your Image is generating. This can take about 1-2 minutes.
        </div>
    </div>

    <!-- Generation Fail -->
    <div id="generation-error"
        class="hidden flex items-center p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"
        role="alert">
        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="currentColor" viewBox="0 0 20 20">
            <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
        </svg>
        <span class="sr-only">Info</span>
        <div>
            <span class="font-medium">Whoops!</span> There was an error genrating your image. Please try again.
        </div>
    </div

    <!-- Title -->
    <header class="py-10">
        <h1 class="text-5xl font-bold text-amber-500">Neuro Lens</h1>
    </header>

    <!-- Instructional Paragraph -->
    <p class="text-center text-lg mb-8" id="instruction">Please upload images to feed your personal AI Influencer</p>

    <!-- FilePond File Uploader -->
    <div class="pond" id="pond_div">
        <input type="file" multiple class="filepond" name="filepond" id="filepond" data-max-files="25"
            data-max-file-size="3MB">
    </div>

    <!-- image generation prompt -->
    <div class="hidden" id="generation-form">
        <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
            <div class="px-4 py-2 bg-white rounded-t-lg dark:bg-gray-800">
                <label for="prompt" class="sr-only">Your prompt</label>
                <textarea id="prompt" rows="4" class="w-full px-0 text-sm text-gray-900 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400" placeholder="Describe an image using me:-) as your AI's name..." required ></textarea>
            </div>
            <div class="flex items-center justify-between px-3 py-2 border-t dark:border-gray-600">
                <button id="generate-button" class="inline-flex items-center py-2.5 px-4 text-xs font-medium text-center text-white bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-200 dark:focus:ring-blue-900 hover:bg-blue-800">
                    Generate
                </button>
            </div>
        </div>
    </div>

    <div id="gallery"></div>

    <!-- FilePond JS -->
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>

    <!-- Initialize FilePond -->
    <script>

        FilePond.registerPlugin(
            // validates the size of the file
            FilePondPluginFileValidateSize,
            // corrects mobile image orientation
            FilePondPluginImageExifOrientation,
            FilePondPluginFilePoster
        );

        // override default options
        FilePond.setOptions({
            dropOnPage: true,
            dropOnElement: true,
        });

    </script>

    <!-- local script -->
    <script>
        $(document).ready(function () {

            // get a reference to the input element
            const inputElement = document.querySelector('input[type="file"]')

            const pond = FilePond.create(inputElement, {
                allowMultiple: true,
                maxFiles: 25,
                credits: false,
                server: {
                    url: 'https://neurolens.scott.ai',
                    process: '/upload',
                    revert: null,
                    headers: {
                        // Add any necessary headers here
                    }
                }
            })

            function hide_it(id) {
                $(id).removeClass('block').addClass('hidden');
            }

            function show_it(id) {
                $(id).removeClass('hidden').addClass('block');
            }

            function use_submit_state() {
                console.log("showing informational banner");
                show_it('#informational-banner');
                hide_it('#generation-form');
                hide_it('#training-banner');
            }

            function use_training_state() {
                console.log("showing training banner");
                hide_it('#informational-banner');
                hide_it('#generation-form');
                show_it('#training-banner');
            }

            function use_generation_state() {
                console.log("showing generation form");
                $('#instruction').text("Describe an image using me:-) as your AI's name.");
                hide_it('#informational-banner');
                hide_it('#training-banner');
                show_it('#generation-form');
                hide_it('#pond_div');
                pond.destroy();
            }

            function use_unknown_state() {
                console.log("hiding both banners");
                hide_it('#informational-banner');
                hide_it('#training-banner');
                hide_it('#generation-form');
            }

            function train_bar() {
                $.ajax({
                    url: '/state',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        info['state'] = 'ready' // TODO remove
                        if (info['state'] == 'submit') {
                           use_submit_state();
                        } else if (info['state'] == 'training') {
                            use_training_state();
                        } else if (info['state'] == 'ready') {
                            use_generation_state();
                        }
                        else {
                            use_unknown_state();
                        }
                        console.log(info);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error getting state.');
                        hide_it('#informational-banner');
                    }
                });

            }

            function invalidate() {
                $.ajax({
                    url: '/clear',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        console.log(info);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error clearing gallery.');
                    }
                });

            }

            function loadGallery() {
                $.ajax({
                    url: '/grid',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    success: function (data) {
                        // On success, replace the content of the #gallery div with the response data
                        $('#gallery').html(data);
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        $('#gallery').html('<p>Error loading gallery.</p>');
                    }
                });
            }

            function startTrain() {
                $.ajax({
                    url: '/train',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    success: function (data) {
                        // On success, replace the content of the #gallery div with the response data
                        train_bar();
                        hide_it('#informational-banner');
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log("Error during training.");
                        hide_it('#informational-banner');
                        hide_it('#training-banner');
                        show_it('#training-error');

                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#training-error');

                            // Call the train-bar function after the message disappears
                            train_bar();
                        }, 5000);
                    }
                });
            }

            // Event listener when a file has been processed (uploaded)
            pond.on('processfile', function (error, file) {
                if (!error) {
                    pond.removeFile(file.id); // remove the file from the pond
                    invalidate(); // clear the zip file
                    loadGallery(); // show all
                    train_bar(); // check if we have enough images
                }
            });

            // train button
            $('#train-button').on('click', function () {
                startTrain();
            });

            //
            function generate_image() {
                $.ajax({
                    url: '/genImage',        // The URL for the AJAX request
                    type: 'POST',            // Method of the request
                    data: {
                        prompt: $('#prompt').val()
                    },
                    success: function (data) {
                        // Turn off the generate button while we wait
                        // and monitor the outcome.
                        $('#generate-button').prop('disabled', true)
                        monitor_generation();
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log("Error generating image.");
                        show_it('#generation-error');
                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#generation-error');
                        }, 5000);
                    }
                });
            }

            function monitor_generation() {
                $.ajax({
                    url: '/image-state',          // The URL for the AJAX request
                    type: 'GET',            // Method of the request
                    success: function (info) {
                        // On success, replace the content of the #gallery div with the response data
                        if (info['state'] == 'complete') {
                            // Turn on the generate button
                            $('#generate-button').prop('disabled', false)
                            hide_it('#generation-banner');
                            loadGallery();
                            train_bar();
                        } else {
                            // Keep checking
                            show_it('#generation-banner');
                            setTimeout(monitor_generation, 5000);
                        }
                        console.log(info); // TODO remove
                    },
                    error: function (xhr, status, error) {
                        // Handle errors here
                        console.log('Error getting state.');
                        hide_it('#generation-banner');
                        show_it('#generation-error');
                        // Hide the error message after 5 seconds (5000 milliseconds)
                        setTimeout(function () {
                            hide_it('#generation-error');
                            $('#generate-button').prop('disabled', false)
                        }, 5000);
                    }
                });
            }

            // generate button
            $('#generate-button').on('click', function () {
                console.log("We will generate the image now.");
                use_unknown_state();
                generate_image();
            });

            // load our gallery
            loadGallery();

            // check if we have enough images
            train_bar();
        });
    </script>

</body>

</html>